# カメラキャリブレーションの方法

## 1. キャリブレーションの準備

1.1　カメラを動作状態にします。<br>
　　　※カラーや解像度の設定は、Autowareでの設定と同一にしてください。

1.2　Velodyneを動作状態にします。

1.3　Autowareを起動します。

1.4　Setupタグ画面で、Baselink to LocalizerのTFを起動します。

1.5　Sensingタグ画面で、Camerasのカメラのノードを起動します。

1.6　Sensingタグ画面で、LIDARsのVelodyneのノードを起動します。

1.7　Sensingタグ画面で、Calibration Tool KitもしくはRVizを起動し、カメラ画像と<br>
　　　Velodyne点群画像をモニタします。

1.8　近距離(5mくらい)での立ち位置を確認します。<br>
　　　チェッカーボードを縦向き([※1](#note1))に持ち、カメラ画像画面の中央下端・中央上端・右下端・<br>
　　　右上端・左下端・左上端の位置（移動可能かつ手の届く範囲で構いません）で、チェッカーボードが<br>
　　　完全にカメラ画像とVelodyneの点群画像に映る範囲を確認しておきます。<br>
　　　地面上に、コインなどを置いて、立ち位置をマークしておくと良いです。<br>
　　　※チェッカーボードのカメラ画像やVelodyne点群画像が欠けていると、キャリブレーションに<br>
　　　　使えません。<br>
　　　※正確なキャリブレーションのためには、カメラおよびVelodyneの視野内の、なるべく広い領域で、<br>
　　　　数多くのポーズのチェッカーボードを記録することが必要です。

1.9　前項と同様にして、遠距離([※2](#note2))での立ち位置を確認します。<br>
　　　※距離が遠すぎると、正確なキャリブレーションができなくなります。

## 2. キャリブレーション用ROSBAGの記録

2.1　最初は、近・中・下・正面のポーズから始めます。（動画を参照）<br>
　　　※遠距離の場合は、ボード上の点群が少なくなるため、身体の点群と混同されないよう、<br>
　　　　なるべく身体をボードの影に隠してください。

2.2　ROSBAGで、/image_raw と /points_raw のトピックを記録開始します。

2.3　近・中・下で、正面→右傾→左傾→下傾→上傾<br>
　　　近・中・上で、正面→右傾→左傾→下傾→上傾<br>
　　　近・右・下で、正面→右傾→左傾→下傾→上傾<br>
　　　近・右・上で、正面→右傾→左傾→下傾→上傾<br>
　　　近・左・下で、正面→右傾→左傾→下傾→上傾<br>
　　　近・左・上で、正面→右傾→左傾→下傾→上傾<br>
　　　遠・中・下で、正面→右傾→左傾→下傾→上傾<br>
　　　遠・中・上で、正面→右傾→左傾→下傾→上傾<br>
　　　遠・右・下で、正面→右傾→左傾→下傾→上傾<br>
　　　遠・右・上で、正面→右傾→左傾→下傾→上傾<br>
　　　遠・左・下で、正面→右傾→左傾→下傾→上傾<br>
　　　遠・左・上で、正面→右傾→左傾→下傾→上傾<br>
　　　の順に、全部で60ポーズ、各ポーズ毎に2秒程度静止します。<br>
　　　ボードを傾ける角度は、30°くらいにします。<br>
　　　※必ずしも、全部のポーズを完全かつ完璧に取得する必要はありません。

2.4　ROSBAGのトピックの記録を終了します。

## 3. Calibration Tool Kitの操作（動画あり）

3.1　前項で取得したキャリブレーション用ROSBAG を一瞬再生します。<br>
　　　Playした後、すぐにPauseしておきます。

3.2　Calibration Tool Kit を起動します。<br>
　　　・「Select Input Image Topic」は「/image_raw」を選択し、OKを押します。<br>
　　　・「Calibration Type」は「Camera->Velodyne」を選択し、OKを押します。<br>
　　　※事前にROSBAGをPlay-Pauseしないと起動できません。

3.3　Pattern SizeとPattern Numberを変更する場合は、値を変更した後、左上の(×)をクリック<br>
　　　してCalibration Tool Kitを一旦終了した後、Calibration Tool Kitを再起動してください。<br>
　　　※Autowareの標準チェッカーボードでの設定値は、以下の通りです。<br>
　　　　・Pattern Size： 0.108 × 0.108<br>
　　　　・Pattern Number： 6 × 8

3.4　ROSBAGを一瞬Pause解除し、再度Pauseします。

3.5　ディスプレィが大きい時は、4つの画像表示パネルを、田の字型に表示されるようにします。

　　　ディスプレィが狭い時は、以下のように、左上と右上のパネルを大きく、<br>
　　　左下と右下のパネルを小さくしておきます。

3.6　左上のカメラ画像パネルは、現在のカメラ画像を表示します。<br>
　　　チェッカーボードが画面中心になるように画像位置を調整します。<br>
　　　チェッカーボードが近・中央・下・正面のポーズであることを確認し、そうでない時は<br>
　　　ROSBAGのPauseを一旦解除し、近・中・下・正面で、再度Pauseします。<br>
　　　※カメラ画像パネルでの操作は、以下の通りです。<br>
　　　・スクロールバーやカーソルキーで、画像が上下左右に動きます。<br>
　　　・マウスホイールで、画像が上下に動きます。

3.7　右上の点群画像パネルは、現在のVelodyne点群を表示します。<br>
　　　最初は視点がVelodyneの位置から下向きなので、低すぎて何も見えません。<br>
　　　"↓"を一回押して、Velodyneを上空から見下ろす感じで点群を表示します。<br>
　　　（背景色が黒の場合は、"b"を押して背景色を灰色に変更しておきます。[※3](#note3)）

　　　※点群画像パネルでの操作は、以下の通りです。<br>
　　　　・視点移動： ↑=前、↓=後、←=左、→=右、PgUp=上、PgDn=下<br>
　　　　・視線回転： a=左、d=右、w=上、s=下、(q=左傾、e=右傾)<br>
　　　　・投影モード切替： 1= 透視投影、(2=正射影)<br>
　　　　・点サイズ： o=小、(p=大)<br>
　　　　・背景色変更： b<br>
　　　　・視点移動量変更： マウスホイール前=増加、マウスホイール後=減少

　　　点群画像パネルでの視点移動のキー操作<br>
　　　Num Lockは解除してください。<br>
　　　視点移動量は、マウスホイールで調節します。<br>
　　　※視点移動なので、画面は反対方向に動きます。

　　　点群画像パネルでの視点回転のキー操作<br>
　　　※視点回転なので、画面は反対方向に動きます。

　　　点群画像パネルでのマウス操作<br>
　　　（点群抽出／解除は、捕捉点群画像パネルのみ）

　　　点群画像パネルの中央にある赤緑青の原点マークは、Velodyneの位置と方向(赤=前方、<br>
　　　緑=左方、青=上方)を表します。<br>
　　　以下の操作で、見やすい位置に視点を移動させます。<br>
　　　　(1) "e"を押し続け、視線が車の前方になるように回転させます。<br>
　　　　(2) マウスホイールを後に回転させて、視点移動量を最小にします。<br>
　　　　(3) "↑"を押し続け、地面がぎりぎり見えるくらいにします。<br>
　　　　　　移動速度は、"↑"を押し続けながら、マウスホイールを前後に回転させて調整します。<br>
　　　　(4) "w"を押し続け、視線を上方に回転させ、チェッカーボードの点群が見えるようにします。<br>
　　　　(5) ↑、↓、←、→、PgUp、PgDn、a、d、w、s キーにより、チェッカーボードを見やすい位置に修正します。<br>
　　　　　　この時、中・下だけでなく、右・左・上・下のポーズでもチェッカーボードが見える位置に<br>
　　　　　　合わせておくと、後の操作が楽になります。

3.8　Grabボタンを押して、カメラ画像とVelodyne点群を捕捉します。<br>
　　　捕捉に失敗した時は、Removeボタンで取り消しができます。<br>
　　　※チェッカーボードの画像が欠けてチェッカーの交点が認識できない時は、Grabできません。

3.9　左下のパネル（捕捉カメラ画像）は、捕捉したカメラ画像を表示します。<br>
　　　"Image_0" のタブが作成されています。<br>
　　　チェッカーボードが画面中心になるように画像位置を調整します。<br>
　　　画像上にチェッカー交点認識結果が表示されることを確認します。<br>
　　　確認後は、パネルを小さくしておきます。<br>
　　　※捕捉カメラ画像パネルの操作方法は、左上のカメラ画像パネルと同じです。

3.10　右下のパネル（捕捉点群画像）は、捕捉したVelodyne点群を表示します。<br>
　　　"Velodyne_0" のタブが作成されています。<br>
　　　カーソルをチェッカーボード上に合わせると、緑色の円と二本の線が表示されることを確認します。<br>
　　　一本は、円の中心軸（円に対して垂直な線）で、他方は円に対して平行な線です。<br>
　　　ここでは、円の中心軸のみが重要であり、円に対して平行な線は無視して構いません。<br>
　　　※捕捉点群画像パネルの操作方法は、右上の点群画像パネルと同じです。

3.11　目視にて、カーソル(円)をチェッカーボードの中心に置き、円がチェッカーボード面に平行に<br>
　　　重なっていて、円に対して垂直な線がチェッカーボード面に対して垂直になっていることを確認し、<br>
　　　左クリックして点群を抽出します。<br>
　　　赤く表示される抽出されたチェッカーボードの点群が、チェッカーボードの中心にあることを<br>
　　　確認します。<br>
　　　抽出に失敗した時は、右クリックで取り消して、再度左クリックで抽出します。<br>
　　　緑の円の直径は実寸([※2](#note2)参照)で、視点との距離に反比例したサイズであり、かつ円内の<br>
　　　点群に対して平行になるように、画面上に表示されます。

3.12　ROSBAGをPause解除し、左上のカメラ画像パネルと右上の点群画像パネルを見ながら、<br>
　　　残り29の近距離のポーズを連続してGrabします。<br>
　　　左下の捕捉カメラ画像パネルには、Image_1～29 のタブが作成されます。<br>
　　　右下の捕捉点群画像パネルには、Velodyne_1～29 のタブが作成されます。

3.13　カメラ画像が遠・中央・下・正面のポーズで、ROSBAGをPauseします。<br>
　　　左上のカメラ画像パネルと右上の点群画像パネルの画像位置を調整して、<br>
　　　見やすい位置にします。

3.14　ROSBAGをPause解除し、左上のカメラ画像パネルと右上の点群画像パネルを見ながら、<br>
　　　残り30の遠距離のポーズを連続してGrabします。<br>
　　　左下の捕捉カメラ画像パネルには、Image_30～59 のタブが作成されます。<br>
　　　右下の捕捉点群画像パネルには、Velodyne_30～59 のタブが作成されます。

3.15　ROSBAGをStopします。

3.16　ディスプレィが狭いときは、左下の捕捉カメラ画像パネルと、右下の捕捉点群画像パネルを<br>
　　　上向き最大に拡大します。

3.17　3.11項と同様にして、Velodyne_59～1 まで、チェッカーボードの中心点群をクリックして<br>
　　　抽出していきます。

3.18　Velodyne_0～59 の全ての中心点群を抽出した後、Calibrateボタンを押して<br>
　　　キャリブレーションデータを計算します。<br>
　　　計算には時間がかかるので、Runtime ManagerのCPU稼働率をモニタして、終了する<br>
　　　のを待ちます。

3.19　計算終了後、Projectボタンを押します。<br>
　　　左下の捕捉カメラ画像パネルの、Image_0～59 のそれぞれのチェッカーボードの中心に、<br>
　　　抽出された点群が重なって赤く表示されていることを確認します。<br>
　　　もし重なり位置の精度が悪い時は、右下の捕捉点群画像パネルの Velodyne_0～59 の<br>
　　　抽出点群の位置を修正(右クリックで取り消し、左クリックで再抽出)した後、再度<br>
　　　Calibrate→Projectしてみます。

3.20　誤差が問題なさそうであれば、Saveボタンを押し、キャリブレーション結果を適当なファイル名<br>
　　　(拡張子は".yaml"を推奨)で保存します。<br>
　　　Save Optionダイアログが表示されるので、「Save Camera Calibration Data ?」は「No」、<br>
　　　「Save Velodyne Calibration Data ?」は「No」を押します。

3.21　左上の(×)をクリックしてCalibration Tool Kitを終了します。

***
## 補足説明

### <a name="note1">※1. チェッカーボードを持つ向きについて

　通常のカメラ・キャリブレーションでは、カメラの視野角は横方向に大きいため、チェッカーボードを<br>
　横向きにして使用します。<br>
　Autowareのキャリブレーションでは、（高分解能の）カメラと、（高さ方向の分解能が粗い）Velodyne<br>
　とのキャリブレーションを同時に行います。<br>
　精度を高めるために、なるべく遠距離でのキャリブレーションも行う必要があるので、チェッカーボード<br>
　には、ある程度の大きさが必要とされます。<br>
　Autowareでは、入手や作成のしやすさから、ボードはA0サイズ(841×1189mm)を推奨しています。

　そして、ボードの持ちやすさと、身体をボードの陰に隠しやすくするのと、ボードを前後に傾けた時に、<br>
　ボード上に投影されるVelodyneのスキャンラインが減るのを軽減するため、縦持ちとしています。

　チェッカーパターン参考URL：<br>
　　<http://wiki.ros.org/camera_calibration/Tutorials/MonocularCalibration?action=AttachFile&do=view&target=check-108.pdf><br>

### <a name="note2">※2. Velodyneとチェッカーボードとの距離の理論的最大値について

　Calibration Tool Kitでの、チェッカーボードの位置の把握は、<br>
　　・カメラ画像においては、チェッカーパターンの自動検出<br>
　　・Velodyne点群画像においては、捕捉点群画像パネル上での手動クリック<br>
　により行われます。

　捕捉点群画像パネルにおいて、クリックして位置入力可能となるには、画面に表示される緑の円内に、<br>
　Velodyneのスキャンラインが最低2本入っていることが必要です。<br>
　ライン1本だけでは、面が確定できないため、緑の円がチェッカーボード面上に正しく表示されません。

　　　スキャンラインが、緑の円の中心にある場合が最悪ケース。（左図）<br>
　　この場合、円の直径の半分以内の距離に、次のスキャンラインが無ければ、平面として検出されない。<br>
　　スキャンラインが最低2本入る条件： 円の直径の半分 > スキャンラインの間隔

　この点群捕捉のための緑の円の直径は、<br>
　　・Pattern Size (m) [width] × Pattern Number [column]<br>
　　・Pattern Size (m) [height] × Pattern Number [row]<br>
　の、いずれか小さい方となっているので、Autowareの標準チェッカーボードでは<br>
　　・Pattern Size [width/height] = 0.108 [m]<br>
　　・Pattern Number [column] = 6<br>
　であるので、円の直径は<br>
　　0.108 × 6 = 0.648 [m]<br>
　となります。

　そして、この円内に Velodyneのスキャンラインが常に2本入る、Velodyneのスキャン間隔の最大値は<br>
　　0.648/2 = 0.324 [m]<br>
　となります。

　これより、ボードとVelodyneとの最大距離は、<br>
　　最大距離 = 0.324 / tan(垂直スキャン間隔角度)<br>
　で求められます。

|型番|垂直スキャン数|垂直スキャン範囲|垂直スキャン間隔|最大距離[m]|
|---|:-:|:-:|:-:|:-:|
|HDL-64e|64|26.8°|0.425°|43.7|
|HDL-32e|32|41.3°|1.332°|13.9|
|VLP-16(30)|16|30°|2°|9.3|
|VLP-16(20)|16|20°|1.333°|13.9|

　さらに、ボードを前後に傾けた状態では、円がボードと平行になるよう変形するため、Velodyneから見た、<br>
　見かけの円の高さは、ボードの傾きに応じて減少します。<br>
　たとえば、前後に30°傾けた場合の短径は、<br>
　　0.648×cos(30°) = 0.561 [m]<br>
　となり、この楕円内に常に2本のスキャンラインが入る、Velodyneのスキャン間隔の最大値は<br>
　　0.561/2 = 0.281 [m]<br>
　となり、これより Velodyne との最大距離は、<br>
　　最大距離 = 0.281 / tan(垂直スキャン間隔角度)<br>
　で求められます。

|型番|垂直スキャン数|垂直スキャン範囲|垂直スキャン間隔|最大距離[m]|
|---|:-:|:-:|:-:|:-:|
|HDL-64e|64|26.8°|0.425°|37.9|
|HDL-32e|32|41.3°|1.332°|12.1|
|VLP-16(30)|16|30°|2°|8.0|
|VLP-16(20)|16|20°|1.333°|12.1|

### <a name="note3">※3. 点群画面の初期背景色を灰色にする方法

　右上の点群画面および右下の捕捉点群画面の初期背景色は黒色となっており、表示される点群を<br>
　見るには、あまり適切ではありません。<br>
　Autowareのソースコードを変更して、catkin_make_release することで、初期背景色を灰色に<br>
　することができます。

　Autoware/ros/src/util/packages/RobotSDK/glviewer/GLViewer/glviewer.cpp の45行目を修正。<br>
　　- cameraparameters.background=Eigen::Vector4d(0,0,0,1);<br>
　　+ cameraparameters.background=Eigen::Vector4d(0.5,0.5,0.5,1);

